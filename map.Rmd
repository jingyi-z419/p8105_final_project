---
title: "Interactive Map"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source: embed
  runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(httr)
library(shiny)
library(leaflet)
```


```{r, include = FALSE}
# import the NYS inpatient data 
ny_cost = 
  GET("https://health.data.ny.gov/resource/7dtz-qxmr.csv",
      query = list("$limit" = 342913)) %>% 
  content("parsed") %>% 
  select(year, pfi, facility_name, apr_severity_of_illness_description, mean_cost) %>% 
  select(pfi, everything())
```



```{r, include = FALSE}
# import the second data containing latitude and longtitude of the hospitals 
coordinates_df = 
   GET("https://health.data.ny.gov/resource/vn5v-hh5r.csv") %>% 
   content("parsed") %>% 
   select(fac_id, facility_name, latitude, longitude) %>% 
   rename(pfi = fac_id) %>% 
   select(pfi, everything())
```


```{r, include = FALSE}
# merge the two dataframes together 
overall_df =
  left_join(ny_cost, coordinates_df, by = "pfi") %>% 
  mutate(facility_name = facility_name.x) %>%
  select(-facility_name.x, -facility_name.y)
```

Column {.sidebar}
-----------------------------------------------------------------------
```{r}
severity_levels = overall_df %>% pull(apr_severity_of_illness_description) %>% unique()

selectInput(
  "severity_levels",
  h3("Severity of Illness"),
  choices = severity_levels,
  selected = "Minor"
)

sliderInput(
  "mean_cost_less1m",
  h3("Mean Cost Range"),
  0, 1000000,
  value = c(100, 5000)
)
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
pal = colorNumeric(
  palette = "viridis",
  domain = overall_df$mean_cost
)

renderLeaflet({
  overall_df %>% 
    filter(
      apr_severity_of_illness_description == input[["severity_levels"]],
      mean_cost %in% input[["mean_cost_less1m"]][1]:input[["mean_cost_less1m"]][2],
      year == "2017"
    ) %>%
    group_by(facility_name) %>%
    leaflet() %>% 
    addProviderTiles(providers$CartoDB.Positron) %>% 
    addCircleMarkers(data = overall_df, lat = ~latitude, lng = ~longitude, radius = .1, color = ~pal(mean_cost))
})
```


